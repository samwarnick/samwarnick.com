map_hash_bucket_size 128;
map $request_uri $redirect_uri {
    include /usr/share/nginx/html/_meta/redirects-map.conf;
}

map $http_accept $format_ext {
    default "";
    "~*avif" ".avif";
    "~*webp" ".webp";
}

server {
    root /usr/share/nginx/html;
    index index.html index.htm;

    # Block direct access to _meta
    location ^~ /_meta {
        deny all;
        return 404;
    }

    # Feed redirects
    rewrite ^/feed\.rss$ /rss.xml permanent;
    rewrite ^/styleguide$ /site/#styleguide redirect;

    # Media - serve optimized formats via content negotiation
    location ^~ /media/ {
        root /usr/share/nginx/html;
        try_files
            $uri$format_ext    # Try AVIF/WebP for images
            $uri.mp4           # Try MP4 for videos
            $uri               # Serve original/resized/unprocessed
            =404;

        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
    }

    # Default location
    location / {
        if ($redirect_uri) {
            return 301 $redirect_uri;
        }
        try_files $uri $uri.html $uri/index.html $uri/index.htm $uri/ =404;
    }

    # Error pages
    error_page 404 /404.html;
    location = /404.html {
        internal;
    }
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        internal;
    }
}