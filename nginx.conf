map_hash_bucket_size 128;
map $request_uri $redirect_uri {
    include /usr/share/nginx/html/redirects-map.conf;
}
server {
    root /usr/share/nginx/html;
    index index.html index.htm;
    # Block direct access to redirects map
    location = /redirects-map.conf {
        deny all;
        return 404;
    }
    # Feed redirects
    rewrite ^/feed\.rss$ /rss.xml permanent;
    rewrite ^/styleguide$ /site/#styleguide redirect;
    # Open Graph images - specific size/format
    location ^~ /media/og/ {
        rewrite ^/media/og/(.*)$ /unsafe/rs:fill:1200:630/plain//$1@jpeg break;
        proxy_pass http://imgproxy:8080;
    }
    # Animated GIFs - process but keep as GIF
    location ~* ^/media/.*\.gif$ {
        rewrite ^/media/(.*)$ /unsafe/plain//$1 break;
        proxy_pass http://imgproxy:8080;
        proxy_set_header Accept $http_accept;
        proxy_set_header Host $host;
        proxy_set_header User-Agent $http_user_agent;
    }
    # Videos - bypass imgproxy (by extension)
    location ~* ^/media/.*\.(mp4|webm|mov|avi|mkv|m4v|flv|wmv|ogv|mp3|wav|ogg|m4a|aac|flac)$ {
        rewrite ^/media/(.*)$ /$1 break;
        proxy_pass https://media.samwarnick.com;
        proxy_ssl_server_name on;
        proxy_ssl_name media.samwarnick.com;
    }
    # Videos - bypass imgproxy (by path, temp fallback)
    location ^~ /media/video/ {
        rewrite ^/media/video/(.*)$ /$1 break;
        proxy_pass https://media.samwarnick.com;
        proxy_ssl_server_name on;
        proxy_ssl_name media.samwarnick.com;
    }
    # Images - convert to AVIF
    location ^~ /media/ {
        rewrite ^/media/(.*)$ /unsafe/plain//$1@avif break;
        proxy_pass http://imgproxy:8080;
        proxy_pass_request_headers      on;
    }
    # Default location
    location / {
        if ($redirect_uri) {
            return 301 $redirect_uri;
        }
        try_files $uri $uri.html $uri/index.html $uri/index.htm $uri/ =404;
    }
    # Error pages
    error_page 404 /404.html;
    location = /404.html {
        internal;
    }
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        internal;
    }
}